# .github/workflows/build-readme.yml
name: Build & Deploy repos README.md (Reusable)

env:
  README_TEMPLATE_PATH: ".github/templates/readme"

on:
  workflow_call:
    inputs:
      template_repo:
        type: string
        required: false
        default: "Academic-Codex/academic-codex.github.io"
      template_ref:
        type: string
        required: false
        default: "main"
      placeholders_path:
        type: string
        required: false
        default: ""

permissions:
  contents: write

concurrency:
  group: "readme"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:

      - name: Debug context (safe)
        run: |
          echo "event=${{ github.event_name }}"
          echo "repo=${{ github.repository }}"
          echo "ref=${{ github.ref }}"
          echo "actor=${{ github.actor }}"
          echo "is_fork=${{ github.event.pull_request.head.repo.fork || '' }}"

      - name: Get Provisioner GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.PROVISIONER_APP_ID }}
          private-key: ${{ secrets.PROVISIONER_PRIVATE_KEY_PEM }}
          
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout central templates + scripts + registry
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.template_repo }}
          ref: ${{ inputs.template_ref }}
          path: central
          sparse-checkout: |
            .github/templates/readme
            .github/scripts/build_readme.py
            .github/registry/repos.yml
          sparse-checkout-cone-mode: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Resolve README config from central registry
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, sys, yaml, re
          from pathlib import Path

          full = (os.environ.get("GITHUB_REPOSITORY") or "").strip()
          if "/" not in full:
            print(f"[fatal] invalid GITHUB_REPOSITORY={full}", file=sys.stderr)
            sys.exit(2)

          owner, repo = full.split("/", 1)  # runtime truth (casing exato)
          owner_l, repo_l = owner.lower(), repo.lower()

          # runtime defaults (não quebra)
          site_url = f"https://{owner}.github.io/" if repo == f"{owner}.github.io" else f"https://{owner}.github.io/{repo}"
          assets_dir = ".github/readme"

          # registry (best-effort)
          hit = {}
          reg = Path("central/.github/registry/repos.yml")
          if reg.exists():
            data = yaml.safe_load(reg.read_text(encoding="utf-8")) or {}
            items = data.get("repos", [])
            if isinstance(items, list):
              hit = next((it for it in items
                          if str(it.get("org","")).lower() == owner_l
                          and str(it.get("name","")).lower() == repo_l), {}) or {}

          # TITLE_1/TITLE_2: tenta usar id + title do registry; se não tiver, deriva do nome do repo
          course_id = (hit.get("id") or "").strip()
          title = (hit.get("title") or "").strip()

          if not course_id:
            course_id = repo.split("-", 1)[0] if "-" in repo else repo

          if not title:
            rest = repo.split("-", 1)[1] if "-" in repo else repo
            title = rest.replace("-", " ").strip()

          # tagline: usa readme_tagline se vier; senão monta de area+level (se existirem)
          area  = (hit.get("academic_area") or "").strip()
          level = (hit.get("academic_level") or "").strip()
          if level:
            lvl = level.lower().strip()
            if lvl == "undergrad":
              level = "Undergraduate Course"
            elif lvl == "grad":
              level = "Graduate Course"
            else:
              level = level[:1].upper() + level[1:]  # fallback

          repo_tagline = (hit.get("readme_tagline") or "").strip()
          if not repo_tagline:
            parts = [p for p in [area, level] if p]
            repo_tagline = " • ".join(parts) if parts else "lectures • notebooks • references"

          out = {
            "TITLE_1": course_id,
            "TITLE_2": title,

            "REPO_TAGLINE": repo_tagline,
            "CTA_TEXT": (hit.get("readme_cta_text") or "Access the full course website").strip(),
            "THEME": (hit.get("readme_theme") or "coding").strip(),

            "SITE_URL": (hit.get("site_url") or site_url).strip(),
            "ASSETS_DIR": (hit.get("readme_assets_dir") or assets_dir).strip(),
          }

          Path("_cfg").mkdir(exist_ok=True)
          Path("_cfg/readme.yml").write_text(
            yaml.safe_dump(out, sort_keys=False, allow_unicode=True),
            encoding="utf-8"
          )

          print("[ok] wrote _cfg/readme.yml")
          print(f"[dbg] runtime repo = {owner}/{repo}", file=sys.stderr)
          PY

      - name: Build README + SVGs
        run: |
          python central/.github/scripts/build_readme.py \
            --repo . \
            --central "central/${{ env.README_TEMPLATE_PATH }}" \
            --repo-cfg "_cfg"

      - name: Configure git identity (GitHub App)
        run: |
          git config user.name "academic-codex-provisioner-app[bot]"
          git config user.email "academic-codex-provisioner-app[bot]@users.noreply.github.com"
        
      - name: Commit changes (if any)
        run: |
          if git diff --quiet; then
            echo "No changes."
            exit 0
          fi

          # adiciona só o que interessa, sem falhar se não existir
          git add README.md || true
          git add .github/readme || true

          git commit -m "Update files"
          git push